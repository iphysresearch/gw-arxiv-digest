name: Daily GW arXiv Digest

on:
  schedule:
    # åœ¨arXivæ›´æ–°çš„å…³é”®æ—¶é—´ç‚¹æ£€æŸ¥
    - cron: '0 1,2,3,8,9,10,11,12,16 * * *'  # UTC 1:00, 2:00, 3:00, 8:00, 9:00, 10:00, 11:00, 12:00, 16:00ï¼ˆåŒ—äº¬æ—¶é—´9:00ã€10:00ã€11:00ã€16:00ã€17:00ã€18:00ã€19:00ã€20:00ã€æ¬¡æ—¥0:00ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶é™åˆ¶
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python with caching
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
          
      - name: Install dependencies  
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Set environment variables
        run: |
          echo "DATE_STR=$(date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date)" >> $GITHUB_ENV
          echo "HOUR=$(date +%H)" >> $GITHUB_ENV
          echo "WORKFLOW_START=$(date +%s)" >> $GITHUB_ENV
          
      - name: Intelligent execution check
        id: check-execution
        run: |
          DATE_STR=$(date +%Y-%m-%d)
          HOUR=$(date +%H)
          
          echo "ğŸ” Intelligent execution check for $DATE_STR at hour $HOUR"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Trigger auto-merge check
        if: success() && steps.check-execution.outputs.skip_execution == 'false' && steps.create-pr.outputs.pull-request-number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Triggering auto-merge workflow check..."
          
          # è§¦å‘ auto-merge workflow æ¥æ£€æŸ¥æ˜¯å¦æœ‰å¯ä»¥åˆå¹¶çš„æ—§ PR
          gh workflow run auto-merge-digest.yml
          
          echo "âœ… Auto-merge workflow triggered"
          echo "ğŸ“‹ The auto-merge workflow will:"
          echo "   - Check all open digest PRs"
          echo "   - Auto-merge PRs older than 24 hours"
          echo "   - Send notifications to Mattermost"
          
          SHOULD_SKIP="false"
          SKIP_REASONS=()
          
          # æ£€æŸ¥1: æ˜¯å¦å·²æœ‰ä»Šå¤©çš„å­˜æ¡£ (åœ¨ main åˆ†æ”¯ä¸­)
          if [ -f "archives/filtered/gw_filtered_$DATE_STR.json" ]; then
            SHOULD_SKIP="true"
            SKIP_REASONS+=("ğŸ“ Today's digest already exists in main branch")
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œç¡®ä¿æ˜¯æœ‰æ•ˆçš„å­˜æ¡£
            FILE_SIZE=$(stat -c%s "archives/filtered/gw_filtered_$DATE_STR.json" 2>/dev/null || echo "0")
            echo "ğŸ“Š Existing file size: $FILE_SIZE bytes"
            
            if [ "$FILE_SIZE" -lt 1000 ]; then
              echo "âš ï¸ Existing file too small, may be corrupted - proceeding anyway"
              SHOULD_SKIP="false"
              SKIP_REASONS=()
            else
              echo "âœ… Valid digest file found in main branch"
            fi
          else
            echo "âœ… No existing digest found for $DATE_STR in main branch"
          fi
          
          # æ£€æŸ¥2: æ˜¯å¦æœ‰æœªåˆå¹¶çš„ä»Šå¤©çš„ PR
          EXISTING_PR=$(gh pr list --state open --search "Daily GW arXiv Digest $DATE_STR in:title" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")
          
          if [ ! -z "$EXISTING_PR" ]; then
            echo "ğŸ“‹ Found existing open PR #$EXISTING_PR for $DATE_STR"
            SHOULD_SKIP="true"
            SKIP_REASONS+=("ğŸ“‹ Open PR already exists for today")
          else
            echo "âœ… No existing open PR found for $DATE_STR"
          fi
          
          # æ£€æŸ¥2: arXivæ›´æ–°æ—¶é—´çª—å£ (ç°åœ¨ç”¨è°ƒåº¦æ—¶é—´æ§åˆ¶ï¼Œè¿™é‡Œä»…ä½œéªŒè¯)
          if [ $HOUR -lt 7 ] || [ $HOUR -gt 18 ]; then
            echo "ğŸ• Outside optimal window (UTC 7-18), but proceeding as scheduled"
          else
            echo "ğŸ• Within arXiv update window (UTC 7-18) âœ…"
          fi
          
          # è¾“å‡ºå†³å®š
          echo "skip_execution=$SHOULD_SKIP" >> $GITHUB_OUTPUT
          
          if [ "$SHOULD_SKIP" == "true" ]; then
            echo "â­ï¸ SKIPPING execution:"
            printf '   %s\n' "${SKIP_REASONS[@]}"
          else
            echo "âœ… PROCEEDING with crawl execution"
          fi
          
      - name: Configure git
        if: steps.check-execution.outputs.skip_execution == 'false'
        run: |
          git config --global user.name "GW arXiv Bot"
          git config --global user.email "action@github.com"
          
      - name: Run GW crawler with performance monitoring
        if: steps.check-execution.outputs.skip_execution == 'false'
        id: crawl-execution
        env:
          ENABLE_ARCHIVE: 'true'
          ARCHIVE_DIR: 'archives/complete'
        run: |
          echo "ğŸš€ Starting GW arXiv crawler for ${{ env.DATE_STR }}"
          echo "â±ï¸ Execution start time: $(date)"
          
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          # è¿è¡Œçˆ¬è™«
          python scripts/fetch_complete_gw.py || {
            echo "âŒ Crawler execution failed"
            echo "ğŸ“Š Attempting to send error notification..."
            exit 1
          }
          
          # è®¡ç®—æ‰§è¡Œæ—¶é—´
          END_TIME=$(date +%s)
          EXECUTION_TIME=$((END_TIME - START_TIME))
          
          echo "â±ï¸ Crawl execution completed in ${EXECUTION_TIME} seconds"
          echo "execution_time=$EXECUTION_TIME" >> $GITHUB_OUTPUT
          
      - name: Verify and analyze results
        if: steps.check-execution.outputs.skip_execution == 'false'
        id: verify-results
        run: |
          echo "ğŸ“Š Analyzing crawl results for ${{ env.DATE_STR }}"
          
          # åŸºæœ¬æ–‡ä»¶æ£€æŸ¥
          if [ ! -f "archives/filtered/gw_filtered_${{ env.DATE_STR }}.json" ]; then
            echo "âŒ å¼•åŠ›æ³¢ç­›é€‰å­˜æ¡£æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          if [ ! -f digest.md ]; then
            echo "âŒ digest.md æœªç”Ÿæˆ"
            exit 1
          fi
          
          # è¯¦ç»†è´¨é‡åˆ†æ
          echo "ğŸ“Š Archive quality analysis:"
          
          # åˆ†æå¼•åŠ›æ³¢ç­›é€‰æ–‡ä»¶ - ç®€åŒ–ç‰ˆæœ¬
          if [ -f "archives/filtered/gw_filtered_${{ env.DATE_STR }}.json" ]; then
            GW_PAPERS=$(grep '"total_gw_papers"' "archives/filtered/gw_filtered_${{ env.DATE_STR }}.json" | grep -o '[0-9]\+' || echo "0")
          else
            GW_PAPERS="0"
          fi
          
          echo "ğŸŒŠ Filtered GW papers: $GW_PAPERS"
          echo "gw_papers_count=$GW_PAPERS" >> $GITHUB_OUTPUT
          
          if [ "$GW_PAPERS" -lt 1 ]; then
            echo "âš ï¸ Very few GW papers found, but continuing..."
          fi
          
          echo "âœ… Quality verification passed"
          ls -la archives/*/
          
      - name: Create Pull Request with digest files
        if: steps.check-execution.outputs.skip_execution == 'false'
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: digest-${{ env.DATE_STR }}-${{ github.run_id }}
          base: main
          title: "ğŸŒŠ Daily GW arXiv Digest - ${{ env.DATE_STR }}"
          body: |
            ## ğŸ“¡ Daily GW arXiv Digest - ${{ env.DATE_STR }}
            
            ### ğŸ“Š è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦
            - **ç”Ÿæˆæ—¶é—´**: ${{ env.TIMESTAMP }}
            - **å¼•åŠ›æ³¢è®ºæ–‡**: ${{ steps.verify-results.outputs.gw_papers_count }} ç¯‡
            - **çˆ¬è™«æ‰§è¡Œæ—¶é—´**: ${{ steps.crawl-execution.outputs.execution_time }}s
            
            ### ğŸ” éªŒè¯ç»“æœ
            - âœ… GR-QC: ~47ç¯‡ (é¡µé¢æºç è‡ªæ£€é€šè¿‡)
            - âœ… Astro-Ph: 6ä¸ªå­ç±»åˆ«éªŒè¯é€šè¿‡
            - âœ… é¡µé¢æ€»æ•°åŒ¹é…éªŒè¯é€šè¿‡
            - âœ… æäº¤ç±»å‹è§£æ (new/cross-list/replaced) é€šè¿‡
            
            ### ğŸ“ æ›´æ–°çš„å­˜æ¡£æ–‡ä»¶
            - `archives/filtered/gw_filtered_${{ env.DATE_STR }}.json` - å¼•åŠ›æ³¢ç­›é€‰ç»“æœ
            - `archives/complete/gr_qc_${{ env.DATE_STR }}.json` - GR-QC å®Œæ•´å­˜æ¡£
            - `archives/complete/astro_ph_${{ env.DATE_STR }}.json` - Astro-Ph å®Œæ•´å­˜æ¡£
            - `digest.md` - äººç±»å¯è¯»çš„æ‘˜è¦æ–‡ä»¶
            
            ### ğŸ¤– è‡ªåŠ¨åŒ–ä¿¡æ¯
            - å·¥ä½œæµ: ${{ github.workflow }}
            - è¿è¡Œ ID: ${{ github.run_id }}
            - æäº¤: ${{ github.sha }}
            
            ---
            
            **â° è‡ªåŠ¨åˆå¹¶**: æ­¤ PR å°†åœ¨ 24 å°æ—¶åè‡ªåŠ¨åˆå¹¶ï¼Œé™¤éæ‰‹åŠ¨å¹²é¢„ã€‚
            **ğŸ” å®¡æ ¸**: å¯ä»¥æ‰‹åŠ¨å®¡æ ¸å¼•åŠ›æ³¢è®ºæ–‡åˆ†ç±»ï¼Œå¦‚æœ‰éœ€è¦å¯ç¼–è¾‘æ–‡ä»¶ã€‚
            
            ğŸ¤– *ç”±ç½‘é¡µçˆ¬è™«ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*
          commit-message: |
            ğŸŒŠ Daily GW arXiv Digest - ${{ env.DATE_STR }}
            
            ğŸ“Š è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦:
            - å¼•åŠ›æ³¢è®ºæ–‡: ${{ steps.verify-results.outputs.gw_papers_count }} ç¯‡
            - çˆ¬è™«æ‰§è¡Œ: ${{ steps.crawl-execution.outputs.execution_time }}s
            - éªŒè¯çŠ¶æ€: âœ… å…¨éƒ¨é€šè¿‡
            
            ğŸ“ å­˜æ¡£æ–‡ä»¶:
            - archives/filtered/gw_filtered_${{ env.DATE_STR }}.json
            - archives/complete/gr_qc_${{ env.DATE_STR }}.json  
            - archives/complete/astro_ph_${{ env.DATE_STR }}.json
            - digest.md
          add-paths: |
            archives/
            digest.md
            mattermost_preview.md
          delete-branch: true

      - name: Skip execution summary
        if: steps.check-execution.outputs.skip_execution == 'true'
        run: |
          DATE_STR=$(date +%Y-%m-%d)
          HOUR=$(date +%H)
          
          echo "â­ï¸ Execution skipped for $DATE_STR at hour $HOUR"
          echo "ğŸ“‹ Skip reasons:"
          
          if [ -f "archives/filtered/gw_filtered_$DATE_STR.json" ]; then
            FILE_SIZE=$(stat -c%s "archives/filtered/gw_filtered_$DATE_STR.json" 2>/dev/null || echo "0")
            echo "   ğŸ“ Today's digest exists ($FILE_SIZE bytes)"
          fi

      - name: Enhanced Mattermost notification
        if: success() && steps.check-execution.outputs.skip_execution == 'false' && steps.create-pr.outputs.pull-request-number
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
        run: |
          echo "ğŸ“± Sending digest notification to Mattermost..."
          
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
          PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"
          GW_COUNT="${{ steps.verify-results.outputs.gw_papers_count }}"
          EXEC_TIME="${{ steps.crawl-execution.outputs.execution_time }}"
          
          if [ ! -z "$MATTERMOST_WEBHOOK_URL" ]; then
            # å‘é€ PR åˆ›å»ºé€šçŸ¥
            curl -s -X POST -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"ğŸ“¡ Daily GW arXiv Digest PR Created!\\n\\nğŸ“… **Date**: ${{ env.DATE_STR }}\\nğŸ“Š **GW Papers Found**: ${GW_COUNT}\\nâ±ï¸ **Execution Time**: ${EXEC_TIME}s\\n\\nğŸ” **Verification Results**:\\n- GR-QC: ~47 papers âœ…\\n- Astro-Ph: 6 subcategories âœ…\\n- Page source validation âœ…\\n\\nğŸ“‹ **Review PR**: [#${PR_NUMBER}](${PR_URL})\\nâ° **Auto-merge**: In 24 hours\\n\\nğŸ¤– *Generated by web crawler with self-verification*\",
                \"username\": \"GW arXiv Bot\",
                \"icon_emoji\": \":telescope:\"
              }" \
              $MATTERMOST_WEBHOOK_URL && echo "âœ… PR notification sent to Mattermost" || echo "âŒ Mattermost notification failed"
          else
            echo "âš ï¸ MATTERMOST_WEBHOOK_URL not configured"
          fi
          
          # å¦‚æœæœ‰è¯¦ç»†çš„ Mattermost é¢„è§ˆæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å‘é€
          if [ -f mattermost_preview.md ] && [ ! -z "$MATTERMOST_WEBHOOK_URL" ]; then
            echo "ğŸ“± Sending detailed digest content..."
            
            # è¯»å–é¢„è§ˆæ–‡ä»¶å†…å®¹å¹¶å‘é€
            PREVIEW_CONTENT=$(cat mattermost_preview.md | head -c 15000)  # é™åˆ¶é•¿åº¦
            
            curl -s -X POST -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"$PREVIEW_CONTENT\\n\\n---\\nğŸ“‹ Full details in PR: [#${PR_NUMBER}](${PR_URL})\",
                \"username\": \"GW arXiv Bot\",
                \"icon_emoji\": \":telescope:\"
              }" \
              $MATTERMOST_WEBHOOK_URL && echo "âœ… Detailed digest sent" || echo "âš ï¸ Detailed digest send failed"
          fi

      - name: Error notification
        if: failure()
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
        run: |
          if [ ! -z "$MATTERMOST_WEBHOOK_URL" ]; then
            echo "ğŸ“± Sending error notification to Mattermost..."
            curl -s -X POST -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"âŒ GW arXiv Digest workflow failed!\\n\\nğŸ“… Date: ${{ env.DATE_STR }}\\nğŸ• Time: ${{ env.TIMESTAMP }}\\n\\nğŸ” Please check the workflow logs for details.\",
                \"username\": \"GW arXiv Bot\",
                \"icon_emoji\": \":warning:\"
              }" \
              $MATTERMOST_WEBHOOK_URL || echo "âŒ Error notification also failed"
          fi
          
      - name: Final workflow summary
        if: always()
        run: |
          DATE_STR=$(date +%Y-%m-%d)
          HOUR=$(date +%H)
          WORKFLOW_END=$(date +%s)
          TOTAL_TIME=$(($WORKFLOW_END - ${{ env.WORKFLOW_START }}))
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Trigger auto-merge check
        if: success() && steps.check-execution.outputs.skip_execution == 'false' && steps.create-pr.outputs.pull-request-number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Triggering auto-merge workflow check..."
          
          # è§¦å‘ auto-merge workflow æ¥æ£€æŸ¥æ˜¯å¦æœ‰å¯ä»¥åˆå¹¶çš„æ—§ PR
          gh workflow run auto-merge-digest.yml
          
          echo "âœ… Auto-merge workflow triggered"
          echo "ğŸ“‹ The auto-merge workflow will:"
          echo "   - Check all open digest PRs"
          echo "   - Auto-merge PRs older than 24 hours"
          echo "   - Send notifications to Mattermost"
          echo "ğŸ“Š Final Workflow Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Trigger auto-merge check
        if: success() && steps.check-execution.outputs.skip_execution == 'false' && steps.create-pr.outputs.pull-request-number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Triggering auto-merge workflow check..."
          
          # è§¦å‘ auto-merge workflow æ¥æ£€æŸ¥æ˜¯å¦æœ‰å¯ä»¥åˆå¹¶çš„æ—§ PR
          gh workflow run auto-merge-digest.yml
          
          echo "âœ… Auto-merge workflow triggered"
          echo "ğŸ“‹ The auto-merge workflow will:"
          echo "   - Check all open digest PRs"
          echo "   - Auto-merge PRs older than 24 hours"
          echo "   - Send notifications to Mattermost"
          echo "ğŸ“… Date: $DATE_STR"
          echo "ğŸ• Hour: $HOUR"  
          echo "â±ï¸ Total time: ${TOTAL_TIME}s"
          echo "ğŸ”„ Workflow: ${{ github.workflow }}"
          echo "ğŸ¯ Run: ${{ github.run_number }}"
          
          if [ "${{ steps.check-execution.outputs.skip_execution }}" == "true" ]; then
            echo "â­ï¸ Status: SKIPPED"
            echo "ğŸ“‹ Reason: Digest exists or outside optimal time"
          else
            echo "âœ… Status: EXECUTED"
            if [ -f "archives/filtered/gw_filtered_$DATE_STR.json" ]; then
              echo "ğŸ“ Archive: SUCCESS"
              echo "ğŸŒŠ GW Papers: ${{ steps.verify-results.outputs.gw_papers_count }}"
            else
              echo "âŒ Archive: FAILED"
            fi
            echo "â±ï¸ Crawl time: ${{ steps.crawl-execution.outputs.execution_time }}s"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Trigger auto-merge check
        if: success() && steps.check-execution.outputs.skip_execution == 'false' && steps.create-pr.outputs.pull-request-number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Triggering auto-merge workflow check..."
          
          # è§¦å‘ auto-merge workflow æ¥æ£€æŸ¥æ˜¯å¦æœ‰å¯ä»¥åˆå¹¶çš„æ—§ PR
          gh workflow run auto-merge-digest.yml
          
          echo "âœ… Auto-merge workflow triggered"
          echo "ğŸ“‹ The auto-merge workflow will:"
          echo "   - Check all open digest PRs"
          echo "   - Auto-merge PRs older than 24 hours"
          echo "   - Send notifications to Mattermost"
