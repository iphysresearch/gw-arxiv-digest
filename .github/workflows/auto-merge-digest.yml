name: Auto-merge Daily Digest PRs

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Auto-merge old digest PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Checking for auto-merge candidates..."
          
          # è·å–æ‰€æœ‰æ‰“å¼€çš„ PR
          gh pr list --state open --json number,title,createdAt,headRefName | jq -r '.[] | select(.title | startswith("ğŸŒŠ Daily GW arXiv Digest")) | "\(.number)|\(.title)|\(.createdAt)|\(.headRefName)"' | while IFS='|' read -r pr_number pr_title created_at head_ref; do
            
            echo "ğŸ“‹ Found digest PR: #$pr_number - $pr_title"
            
            # è®¡ç®— PR å¹´é¾„ï¼ˆå°æ—¶ï¼‰
            created_timestamp=$(date -d "$created_at" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$created_at" +%s 2>/dev/null || echo "0")
            current_timestamp=$(date +%s)
            age_hours=$(( (current_timestamp - created_timestamp) / 3600 ))
            
            echo "â° PR age: $age_hours hours"
            
            # å¦‚æœ PR è¶…è¿‡ 24 å°æ—¶ï¼Œè‡ªåŠ¨åˆå¹¶
            if [ "$age_hours" -gt 24 ]; then
              echo "ğŸ”„ Auto-merging PR #$pr_number (age: $age_hours hours)"
              
              # æ£€æŸ¥ PR çŠ¶æ€
              pr_mergeable=$(gh pr view $pr_number --json mergeable --jq '.mergeable')
              
              if [ "$pr_mergeable" = "MERGEABLE" ]; then
                # è‡ªåŠ¨åˆå¹¶
                gh pr merge $pr_number --squash --delete-branch --body "ğŸ¤– Auto-merged after 24 hours as planned"
                echo "âœ… PR #$pr_number merged successfully"
                
                # å‘é€é€šçŸ¥åˆ° Mattermost (å¦‚æœé…ç½®äº†)
                if [ ! -z "${{ secrets.MATTERMOST_WEBHOOK_URL }}" ]; then
                  curl -s -X POST -H 'Content-Type: application/json' \
                    -d "{
                      \"text\": \"âœ… Auto-merged daily digest PR #$pr_number\\n\\nğŸ“… Date: $(echo '$pr_title' | grep -o '[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}')\\nâ° Age: $age_hours hours\\nğŸ”„ Status: Automatically merged\",
                      \"username\": \"GW arXiv Bot\",
                      \"icon_emoji\": \":white_check_mark:\"
                    }" \
                    ${{ secrets.MATTERMOST_WEBHOOK_URL }} || echo "âš ï¸ Mattermost notification failed"
                fi
              else
                echo "âš ï¸ PR #$pr_number is not mergeable, skipping"
                
                # å¦‚æœ PR ä¸èƒ½åˆå¹¶ä¸”è¶…è¿‡ 48 å°æ—¶ï¼Œå‘é€è­¦å‘Š
                if [ "$age_hours" -gt 48 ]; then
                  echo "ğŸš¨ PR #$pr_number has been open for $age_hours hours and cannot be merged"
                  
                  if [ ! -z "${{ secrets.MATTERMOST_WEBHOOK_URL }}" ]; then
                    curl -s -X POST -H 'Content-Type: application/json' \
                      -d "{
                        \"text\": \"ğŸš¨ Digest PR requires attention!\\n\\nPR #$pr_number has been open for $age_hours hours but cannot be auto-merged.\\n\\nğŸ“‹ Title: $pr_title\\nğŸ” Please check for conflicts or issues.\",
                        \"username\": \"GW arXiv Bot\",
                        \"icon_emoji\": \":warning:\"
                      }" \
                      ${{ secrets.MATTERMOST_WEBHOOK_URL }} || echo "âš ï¸ Warning notification failed"
                  fi
                fi
              fi
            else
              echo "â³ PR #$pr_number is only $age_hours hours old, waiting..."
            fi
            
            echo "---"
          done
          
          echo "âœ… Auto-merge check completed"
