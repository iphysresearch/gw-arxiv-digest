version: '3.8'

services:
  # GitHub Actions 本地测试环境
  github-actions-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: gw-arxiv-actions-test
    working_dir: /workspace
    volumes:
      - .:/workspace
    environment:
      - DEBIAN_FRONTEND=noninteractive
      - PYTHONUNBUFFERED=1
      - MATTERMOST_WEBHOOK_URL=http://mattermost-mock/hooks/test
      - GITHUB_TOKEN=test-token
      - ENABLE_ARCHIVE=true
      - ARCHIVE_DIR=archives/complete
      - DATE_STR=${DATE_STR:-$(date +%Y-%m-%d)}
    command: bash -c "echo '🚀 GitHub Actions test environment ready!' && tail -f /dev/null"
    networks:
      - test-network
    depends_on:
      - mattermost-mock

  # 本地 Mattermost 测试服务
  mattermost-mock:
    image: nginx:alpine
    container_name: mattermost-mock
    ports:
      - "8080:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/webhook-mock.html:/usr/share/nginx/html/index.html:ro
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
